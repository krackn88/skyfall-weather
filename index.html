<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¤</text></svg>">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-base: #0b0f19;
      --bg-primary: #111827;
      --bg-card: rgba(17, 24, 39, 0.85);
      --bg-card-solid: #1a2235;
      --bg-elevated: #1e293b;
      --bg-hover: #263248;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-glow: rgba(56, 189, 248, 0.25);
      --yellow: #fbbf24;
      --orange: #fb923c;
      --red: #f87171;
      --green: #4ade80;
      --purple: #a78bfa;
      --pink: #f472b6;
      --cyan: #22d3ee;
      --border: rgba(148, 163, 184, 0.08);
      --border-light: rgba(148, 163, 184, 0.15);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 48px rgba(0,0,0,0.5);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 6px;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Animated Background â”€â”€ */
    .bg-gradient {
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }
    .bg-gradient::before {
      content: '';
      position: absolute;
      top: -40%;
      left: -20%;
      width: 80%;
      height: 80%;
      background: radial-gradient(ellipse, rgba(56, 189, 248, 0.06) 0%, transparent 70%);
      animation: drift 25s ease-in-out infinite alternate;
    }
    .bg-gradient::after {
      content: '';
      position: absolute;
      bottom: -30%;
      right: -15%;
      width: 70%;
      height: 70%;
      background: radial-gradient(ellipse, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
      animation: drift 30s ease-in-out infinite alternate-reverse;
    }
    @keyframes drift {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(60px, -40px) scale(1.1); }
    }

    /* â”€â”€ Loading â”€â”€ */
    .loading-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg-base);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      transition: opacity 0.6s var(--ease), visibility 0.6s;
    }
    .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .loading-spinner {
      width: 52px; height: 52px;
      border: 3px solid var(--bg-elevated);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-screen p { color: var(--text-secondary); font-size: 14px; font-weight: 500; }

    /* â”€â”€ App Shell â”€â”€ */
    .app {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }
    .app.visible { display: block; animation: fadeUp 0.5s var(--ease); }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
    }
    .brand i { color: var(--accent); font-size: 24px; }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-box {
      position: relative;
    }
    .search-box input {
      width: 280px;
      padding: 10px 14px 10px 40px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: all 0.25s var(--ease);
    }
    .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    .search-box input::placeholder { color: var(--text-muted); }
    .search-box .ico { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px; }
    .search-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0; right: 0;
      background: var(--bg-card-solid);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 100;
      max-height: 300px;
      overflow-y: auto;
    }
    .search-dropdown.open { display: block; }
    .search-item {
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover { background: var(--bg-hover); }
    .search-item .flag { font-size: 16px; }
    .search-item .sname { color: var(--text-primary); }
    .search-item .sdetail { color: var(--text-muted); font-size: 11px; margin-left: auto; }
    .btn {
      padding: 10px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s var(--ease);
      white-space: nowrap;
    }
    .btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn.active { background: var(--accent-soft); color: var(--accent); border-color: rgba(56,189,248,0.2); }
    .btn i { font-size: 14px; }
    .btn-icon {
      width: 40px; height: 40px;
      padding: 0;
      justify-content: center;
      border-radius: 12px;
    }

    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: var(--bg-card);
      -webkit-backdrop-filter: blur(24px);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: transform 0.2s var(--ease), box-shadow 0.2s var(--ease);
    }
    .card:hover { box-shadow: var(--shadow); }
    .card-label {
      padding: 16px 20px 0;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-label i { color: var(--accent); font-size: 12px; }
    .card-inner { padding: 16px 20px 20px; }

    /* â”€â”€ Grid Layout â”€â”€ */
    .grid-main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .stats-section {
      margin-bottom: 16px;
      transition: margin 0.3s var(--ease);
    }
    .stats-section.collapsed { margin-bottom: 0; }
    .stats-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-card);
      -webkit-backdrop-filter: blur(24px);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border);
      border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      transition: background 0.15s, border-radius 0.2s;
    }
    .stats-section-header:hover { background: var(--bg-elevated); }
    .stats-section.collapsed .stats-section-header { border-radius: var(--radius); border-bottom: 1px solid var(--border); }
    .stats-section-header .label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stats-section-header .label i { color: var(--accent); font-size: 13px; }
    .stats-section-toggle {
      padding: 6px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      font-family: inherit;
    }
    .stats-section-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
    .stats-section-body {
      padding: 16px;
      background: var(--bg-card);
      -webkit-backdrop-filter: blur(24px);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      overflow: hidden;
      max-height: 500px;
      transition: max-height 0.35s var(--ease), padding 0.35s var(--ease), border 0.2s, opacity 0.25s;
    }
    .stats-section.collapsed .stats-section-body {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      border: none;
      opacity: 0;
      pointer-events: none;
    }
    .grid-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .grid-bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    /* â”€â”€ Current Weather Hero â”€â”€ */
    .hero-current {
      grid-column: 1 / -1;
      position: relative;
      overflow: hidden;
    }
    .hero-current .card-inner {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      padding: 28px 28px 24px;
    }
    .hero-left { flex: 1; }
    .hero-location {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hero-location .loc-pin { color: var(--accent); font-size: 16px; }
    .hero-subloc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .hero-temp-row {
      display: flex;
      align-items: flex-start;
      gap: 20px;
    }
    .hero-temp {
      font-size: 80px;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -3px;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-temp-info { padding-top: 8px; }
    .hero-condition {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .hero-feels {
      font-size: 13px;
      color: var(--text-muted);
    }
    .hero-hi-lo {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      font-size: 13px;
      font-weight: 500;
    }
    .hero-hi { color: var(--orange); }
    .hero-lo { color: var(--accent); }
    .hero-right {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .hero-icon {
      font-size: 72px;
      line-height: 1;
    }
    .hero-updated {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* â”€â”€ Hourly Forecast â”€â”€ */
    .hourly-scroll {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      scroll-snap-type: x mandatory;
      scrollbar-width: thin;
      scrollbar-color: var(--bg-hover) transparent;
    }
    .hourly-scroll::-webkit-scrollbar { height: 4px; }
    .hourly-scroll::-webkit-scrollbar-track { background: transparent; }
    .hourly-scroll::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 2px; }
    .hour-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 14px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      min-width: 72px;
      scroll-snap-align: start;
      transition: background 0.15s;
      border: 1px solid transparent;
    }
    .hour-item.now { border-color: var(--accent); background: var(--accent-soft); }
    .hour-item .h-time { font-size: 11px; color: var(--text-muted); font-weight: 500; }
    .hour-item .h-icon { font-size: 20px; }
    .hour-item .h-temp { font-size: 14px; font-weight: 700; }
    .hour-item .h-precip { font-size: 10px; color: var(--accent); font-weight: 500; }
    .hour-item .h-snow { font-size: 10px; color: var(--purple); font-weight: 500; }

    /* â”€â”€ 3-Day Forecast â”€â”€ */
    .daily-list { display: flex; flex-direction: column; gap: 6px; }
    .daily-row {
      display: grid;
      grid-template-columns: 100px 40px 1fr 60px 70px;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      transition: background 0.15s;
    }
    .daily-row:hover { background: var(--bg-hover); }
    .daily-day { font-size: 14px; font-weight: 600; }
    .daily-day .day-date { display: block; font-size: 11px; font-weight: 400; color: var(--text-muted); }
    .daily-icon { font-size: 22px; text-align: center; }
    .daily-bar-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 6px;
    }
    .daily-bar {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      position: relative;
      background: var(--bg-base);
      overflow: hidden;
    }
    .daily-bar-fill {
      position: absolute;
      top: 0; bottom: 0;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent), var(--orange));
    }
    .daily-lo, .daily-hi { font-size: 12px; font-weight: 600; min-width: 30px; }
    .daily-lo { color: var(--text-muted); text-align: right; }
    .daily-hi { color: var(--text-primary); }
    .daily-precip-col { font-size: 12px; color: var(--accent); text-align: right; font-weight: 500; }
    .daily-snow-col { font-size: 12px; color: var(--purple); text-align: right; font-weight: 600; }
    .daily-snow-col i { margin-right: 2px; }
    .snow-forecast-card {
      background: linear-gradient(135deg, rgba(167, 139, 250, 0.08) 0%, rgba(139, 92, 246, 0.04) 100%);
      border-color: rgba(167, 139, 250, 0.2);
    }
    .snow-forecast-card .card-label i { color: var(--purple); }

    /* â”€â”€ Stat Cards â”€â”€ */
    .stat-card .card-inner { padding: 16px 18px 18px; }
    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .stat-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      font-weight: 600;
    }
    .stat-icon { font-size: 16px; }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-unit { font-size: 14px; font-weight: 400; color: var(--text-muted); }
    .stat-desc { font-size: 12px; color: var(--text-muted); }

    /* â”€â”€ Sun Card â”€â”€ */
    .sun-visual {
      position: relative;
      height: 80px;
      margin: 10px 0 8px;
    }
    .sun-arc {
      position: absolute;
      bottom: 0;
      left: 10%;
      width: 80%;
      height: 100%;
    }
    .sun-arc svg { width: 100%; height: 100%; overflow: visible; }
    .sun-times {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    .sun-rise, .sun-set { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .sun-rise i { color: var(--yellow); }
    .sun-set i { color: var(--orange); }
    .sun-time-val { font-weight: 600; font-size: 14px; }
    .sun-label { color: var(--text-muted); font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* â”€â”€ Map â”€â”€ */
    .map-card { grid-column: 1 / -1; }
    .map-card .card-inner { padding: 0; }
    #weatherMap {
      width: 100%;
      height: 360px;
      border-radius: 0 0 var(--radius) var(--radius);
      transition: height 0.35s var(--ease);
    }
    .stats-section.collapsed ~ .map-card #weatherMap {
      height: min(560px, 60vh);
    }
    .map-controls {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      flex-wrap: wrap;
    }
    .map-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .map-btn.active { background: var(--accent-soft); color: var(--accent); border-color: rgba(56,189,248,0.3); }
    .map-btn:hover { background: var(--bg-hover); }
    .map-control-group {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 11px;
    }
    .map-control-group input[type="range"] {
      width: 90px;
      accent-color: #38bdf8;
      cursor: pointer;
    }

    /* â”€â”€ Leaflet Overrides â”€â”€ */
    .leaflet-control-zoom { border: none !important; }
    .leaflet-control-zoom a {
      background: var(--bg-card-solid) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-light) !important;
      width: 32px !important; height: 32px !important; line-height: 32px !important;
    }
    .leaflet-control-zoom a:hover { background: var(--accent) !important; color: #fff !important; }
    .leaflet-control-zoom-in { border-radius: 8px 8px 0 0 !important; }
    .leaflet-control-zoom-out { border-radius: 0 0 8px 8px !important; }
    .leaflet-control-attribution { display: none !important; }

    /* â”€â”€ Wind Direction Arrow â”€â”€ */
    .wind-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px; height: 36px;
      border-radius: 50%;
      background: var(--bg-base);
      margin-top: 6px;
    }
    .wind-arrow i { transition: transform 0.3s var(--ease); }

    /* â”€â”€ Error State â”€â”€ */
    .error-msg {
      text-align: center;
      padding: 60px 20px;
    }
    .error-msg i { font-size: 48px; color: var(--red); margin-bottom: 16px; }
    .error-msg h2 { font-size: 20px; margin-bottom: 8px; }
    .error-msg p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 1024px) {
      .grid-stats { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .app { padding: 12px; }
      .grid-main { grid-template-columns: 1fr; }
      .grid-bottom { grid-template-columns: 1fr; }
      .grid-stats { grid-template-columns: repeat(2, 1fr); }
      .header { gap: 10px; }
      .search-box input { width: 200px; }
      .hero-current .card-inner { flex-direction: column; padding: 20px; }
      .hero-temp { font-size: 60px; }
      .hero-icon { font-size: 56px; }
      .hero-right { flex-direction: row; gap: 12px; }
      .daily-row { grid-template-columns: 70px 28px 1fr 45px 55px; gap: 8px; padding: 10px; font-size: 12px; }
    }
    @media (max-width: 480px) {
      .grid-stats { grid-template-columns: 1fr 1fr; }
      .brand span { display: none; }
      .search-box input { width: 160px; }
      .hero-temp { font-size: 52px; }
    }
  </style>
</head>
<body>
  <div class="bg-gradient"></div>

  <!-- Loading -->
  <div class="loading-screen" id="loader">
    <div class="loading-spinner"></div>
    <p>Detecting your location...</p>
  </div>

  <!-- App -->
  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="brand">
        <i class="fas fa-cloud-sun-rain"></i>
        <span>Weather</span>
      </div>
      <div class="header-actions">
        <div class="search-box">
          <i class="fas fa-search ico"></i>
          <input type="text" id="searchInput" placeholder="Search city..." autocomplete="off" spellcheck="false">
          <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        <button class="btn" id="unitToggle" onclick="toggleUnits()">
          <i class="fas fa-temperature-half"></i>
          <span id="unitLabel">Â°C</span>
        </button>
        <button class="btn btn-icon" onclick="detectLocation()" title="Detect my location">
          <i class="fas fa-crosshairs"></i>
        </button>
      </div>
    </header>

    <!-- Content injected by JS -->
    <div id="content"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API = 'https://api.open-meteo.com/v1/forecast';
    const GEO_API = 'https://geocoding-api.open-meteo.com/v1/search';
    const RAINVIEWER_API = 'https://api.rainviewer.com/public/weather-maps.json';
    const AIR_API = 'https://air-quality-api.open-meteo.com/v1/air-quality';

    const WEATHER_REFRESH_MS = 15 * 60 * 1000; // 15 minutes

    let state = {
      lat: null, lon: null,
      city: '', region: '', country: '',
      timezone: 'auto',
      units: localStorage.getItem('wx_units') || 'metric', // metric or imperial
      weather: null,
      airQuality: null,
      map: null,
      radarLayer: null,
      radarFrames: [],
      radarIdx: 0,
      radarPlaying: false,
      radarInterval: null,
      radarOpacity: 0.6,
      weatherRefreshInterval: null
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WMO WEATHER CODES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const WMO = {
      0:  { text: 'Clear Sky',          icon: 'â˜€ï¸',  iconNight: 'ğŸŒ™',  fa: 'fa-sun',              faNight: 'fa-moon',          color: 'var(--yellow)' },
      1:  { text: 'Mainly Clear',       icon: 'ğŸŒ¤ï¸', iconNight: 'ğŸŒ™',  fa: 'fa-sun',              faNight: 'fa-moon',          color: 'var(--yellow)' },
      2:  { text: 'Partly Cloudy',      icon: 'â›…',  iconNight: 'â˜ï¸',  fa: 'fa-cloud-sun',        faNight: 'fa-cloud-moon',    color: 'var(--text-secondary)' },
      3:  { text: 'Overcast',           icon: 'â˜ï¸',  iconNight: 'â˜ï¸',  fa: 'fa-cloud',            faNight: 'fa-cloud',         color: 'var(--text-muted)' },
      45: { text: 'Fog',                icon: 'ğŸŒ«ï¸', iconNight: 'ğŸŒ«ï¸', fa: 'fa-smog',             faNight: 'fa-smog',          color: 'var(--text-muted)' },
      48: { text: 'Rime Fog',           icon: 'ğŸŒ«ï¸', iconNight: 'ğŸŒ«ï¸', fa: 'fa-smog',             faNight: 'fa-smog',          color: 'var(--text-muted)' },
      51: { text: 'Light Drizzle',      icon: 'ğŸŒ¦ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-sun-rain',   faNight: 'fa-cloud-rain',    color: 'var(--accent)' },
      53: { text: 'Drizzle',            icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-rain',       faNight: 'fa-cloud-rain',    color: 'var(--accent)' },
      55: { text: 'Dense Drizzle',      icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-rain',       faNight: 'fa-cloud-rain',    color: 'var(--accent)' },
      56: { text: 'Freezing Drizzle',   icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-rain',       faNight: 'fa-cloud-rain',    color: 'var(--cyan)' },
      57: { text: 'Heavy Frz. Drizzle', icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-rain',       faNight: 'fa-cloud-rain',    color: 'var(--cyan)' },
      61: { text: 'Slight Rain',        icon: 'ğŸŒ¦ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-sun-rain',   faNight: 'fa-cloud-rain',    color: 'var(--accent)' },
      63: { text: 'Moderate Rain',      icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-showers-heavy', faNight: 'fa-cloud-showers-heavy', color: 'var(--accent)' },
      65: { text: 'Heavy Rain',         icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-showers-heavy', faNight: 'fa-cloud-showers-heavy', color: 'var(--accent)' },
      66: { text: 'Light Freezing Rain', icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-icicles',          faNight: 'fa-icicles',       color: 'var(--cyan)' },
      67: { text: 'Heavy Freezing Rain', icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-icicles',          faNight: 'fa-icicles',       color: 'var(--cyan)' },
      71: { text: 'Slight Snow',        icon: 'ğŸŒ¨ï¸', iconNight: 'ğŸŒ¨ï¸', fa: 'fa-snowflake',        faNight: 'fa-snowflake',     color: 'var(--purple)' },
      73: { text: 'Moderate Snow',      icon: 'ğŸŒ¨ï¸', iconNight: 'ğŸŒ¨ï¸', fa: 'fa-snowflake',        faNight: 'fa-snowflake',     color: 'var(--purple)' },
      75: { text: 'Heavy Snow',         icon: 'â„ï¸',  iconNight: 'â„ï¸',  fa: 'fa-snowflake',        faNight: 'fa-snowflake',     color: 'var(--purple)' },
      77: { text: 'Snow Grains',        icon: 'ğŸŒ¨ï¸', iconNight: 'ğŸŒ¨ï¸', fa: 'fa-snowflake',        faNight: 'fa-snowflake',     color: 'var(--purple)' },
      80: { text: 'Slight Showers',     icon: 'ğŸŒ¦ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-sun-rain',   faNight: 'fa-cloud-rain',    color: 'var(--accent)' },
      81: { text: 'Moderate Showers',   icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-showers-heavy', faNight: 'fa-cloud-showers-heavy', color: 'var(--accent)' },
      82: { text: 'Violent Showers',    icon: 'ğŸŒ§ï¸', iconNight: 'ğŸŒ§ï¸', fa: 'fa-cloud-showers-heavy', faNight: 'fa-cloud-showers-heavy', color: 'var(--accent)' },
      85: { text: 'Slight Snow Showers', icon: 'ğŸŒ¨ï¸', iconNight: 'ğŸŒ¨ï¸', fa: 'fa-snowflake',       faNight: 'fa-snowflake',     color: 'var(--purple)' },
      86: { text: 'Heavy Snow Showers', icon: 'â„ï¸',  iconNight: 'â„ï¸',  fa: 'fa-snowflake',        faNight: 'fa-snowflake',     color: 'var(--purple)' },
      95: { text: 'Thunderstorm',       icon: 'â›ˆï¸',  iconNight: 'â›ˆï¸',  fa: 'fa-bolt',             faNight: 'fa-bolt',          color: 'var(--yellow)' },
      96: { text: 'T-Storm w/ Hail',    icon: 'â›ˆï¸',  iconNight: 'â›ˆï¸',  fa: 'fa-bolt',             faNight: 'fa-bolt',          color: 'var(--yellow)' },
      99: { text: 'T-Storm w/ Heavy Hail', icon: 'â›ˆï¸', iconNight: 'â›ˆï¸', fa: 'fa-bolt',           faNight: 'fa-bolt',          color: 'var(--red)' }
    };

    function getWMO(code, isDay) {
      const w = WMO[code] || WMO[0];
      return {
        text: w.text,
        emoji: isDay ? w.icon : (w.iconNight || w.icon),
        fa: isDay ? w.fa : (w.faNight || w.fa),
        color: w.color
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UNITS HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const isImperial = () => state.units === 'imperial';
    const tempUnit = () => isImperial() ? 'Â°F' : 'Â°C';
    const windUnit = () => isImperial() ? 'mph' : 'km/h';
    const precipUnit = () => isImperial() ? 'in' : 'mm';
    const visUnit = () => isImperial() ? 'mi' : 'km';
    const convTemp = (c) => isImperial() ? (c * 9/5) + 32 : c;
    const convWind = (kmh) => isImperial() ? kmh * 0.621371 : kmh;
    const convPrecip = (mm) => isImperial() ? mm * 0.03937 : mm;
    const convSnow = (cm) => isImperial() ? cm * 0.3937 : cm;
    const convVis = (km) => isImperial() ? km * 0.621371 : km;
    const snowUnit = () => isImperial() ? 'in' : 'cm';
    const fmt = (v, d=0) => v == null ? '--' : Number(v).toFixed(d);

    function toggleUnits() {
      state.units = isImperial() ? 'metric' : 'imperial';
      localStorage.setItem('wx_units', state.units);
      document.getElementById('unitLabel').textContent = tempUnit();
      if (state.weather) renderWeather();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GEOLOCATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function detectLocation() {
      if (!navigator.geolocation) {
        showError('Geolocation not supported', 'Your browser does not support geolocation.');
        return;
      }
      showLoader('Detecting your location...');
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          state.lat = pos.coords.latitude;
          state.lon = pos.coords.longitude;
          // Reverse geocode
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${state.lat}&lon=${state.lon}&format=json&zoom=10`);
            const geo = await res.json();
            const a = geo.address || {};
            state.city = a.city || a.town || a.village || a.hamlet || a.county || 'Unknown';
            state.region = a.state || a.province || '';
            state.country = a.country || '';
          } catch(e) {
            state.city = `${state.lat.toFixed(2)}, ${state.lon.toFixed(2)}`;
            state.region = '';
            state.country = '';
          }
          await loadWeather();
        },
        (err) => {
          console.warn('Geolocation error:', err);
          // Fall back to IP-based (rough) - use a default
          showLoader('Using default location...');
          state.lat = 40.7128;
          state.lon = -74.006;
          state.city = 'New York';
          state.region = 'New York';
          state.country = 'United States';
          loadWeather();
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FETCH WEATHER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadWeather(silent = false) {
      if (!silent) showLoader('Loading weather data...');
      try {
        const weatherParams = new URLSearchParams({
          latitude: state.lat,
          longitude: state.lon,
          current: [
            'temperature_2m','relative_humidity_2m','apparent_temperature','is_day',
            'precipitation','rain','showers','snowfall','weather_code','cloud_cover',
            'pressure_msl','surface_pressure','wind_speed_10m','wind_direction_10m',
            'wind_gusts_10m'
          ].join(','),
          hourly: [
            'temperature_2m','relative_humidity_2m','apparent_temperature','precipitation_probability',
            'precipitation','rain','showers','snowfall','weather_code','cloud_cover',
            'visibility','wind_speed_10m','wind_direction_10m','wind_gusts_10m',
            'uv_index','is_day','dew_point_2m'
          ].join(','),
          daily: [
            'weather_code','temperature_2m_max','temperature_2m_min','apparent_temperature_max',
            'apparent_temperature_min','sunrise','sunset','daylight_duration','sunshine_duration',
            'uv_index_max','precipitation_sum','rain_sum','showers_sum','snowfall_sum',
            'precipitation_hours','precipitation_probability_max','wind_speed_10m_max',
            'wind_gusts_10m_max','wind_direction_10m_dominant'
          ].join(','),
          timezone: 'auto',
          forecast_days: 4,
          past_hours: 1
        });

        const airParams = new URLSearchParams({
          latitude: state.lat,
          longitude: state.lon,
          hourly: ['us_aqi', 'pm2_5', 'pm10'].join(','),
          timezone: 'auto',
          forecast_days: 2,
          past_hours: 1
        });

        const [weatherRes, airRes] = await Promise.all([
          fetch(`${API}?${weatherParams}`),
          fetch(`${AIR_API}?${airParams}`)
        ]);

        if (!weatherRes.ok) throw new Error(`API error: ${weatherRes.status}`);
        state.weather = await weatherRes.json();

        if (airRes.ok) {
          state.airQuality = await airRes.json();
        } else {
          state.airQuality = null;
        }
        if (!silent) hideLoader();
        renderWeather();
        startWeatherRefreshInterval();
      } catch (e) {
        console.error(e);
        if (!silent) hideLoader();
        if (!silent) showError('Failed to load weather', e.message);
      }
    }

    function startWeatherRefreshInterval() {
      if (state.weatherRefreshInterval) clearInterval(state.weatherRefreshInterval);
      state.weatherRefreshInterval = setInterval(() => {
        if (state.lat != null && state.lon != null) {
          loadWeather(true); // silent refresh
        }
      }, WEATHER_REFRESH_MS);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEARCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let searchTimer = null;
    const searchInput = document.getElementById('searchInput');
    const searchDrop = document.getElementById('searchDropdown');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimer);
      const q = e.target.value.trim();
      if (q.length < 2) { searchDrop.classList.remove('open'); return; }
      searchTimer = setTimeout(async () => {
        try {
          const res = await fetch(`${GEO_API}?name=${encodeURIComponent(q)}&count=8&language=en&format=json`);
          const data = await res.json();
          const results = data.results || [];
          if (!results.length) {
            searchDrop.innerHTML = '<div class="search-item" style="color:var(--text-muted)">No results</div>';
          } else {
            searchDrop.innerHTML = results.map((r, i) => {
              const flag = r.country_code ? getFlagEmoji(r.country_code) : '';
              const detail = [r.admin1, r.country].filter(Boolean).join(', ');
              return `<div class="search-item" onclick="selectSearchResult(${i})" data-idx="${i}">
                <span class="flag">${flag}</span>
                <span class="sname">${r.name}</span>
                <span class="sdetail">${detail}</span>
              </div>`;
            }).join('');
            // Store results for click handler
            searchDrop._results = results;
          }
          searchDrop.classList.add('open');
        } catch(e) { console.error(e); }
      }, 300);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { searchDrop.classList.remove('open'); searchInput.blur(); }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-box')) searchDrop.classList.remove('open');
    });

    function selectSearchResult(idx) {
      const r = searchDrop._results[idx];
      state.lat = r.latitude;
      state.lon = r.longitude;
      state.city = r.name;
      state.region = r.admin1 || '';
      state.country = r.country || '';
      searchInput.value = '';
      searchDrop.classList.remove('open');
      loadWeather();
    }

    function getFlagEmoji(cc) {
      return cc.toUpperCase().replace(/./g, c => String.fromCodePoint(0x1F1E6 - 65 + c.charCodeAt(0)));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderWeather() {
      const w = state.weather;
      if (!w) return;

      const cur = w.current;
      const hourly = w.hourly;
      const daily = w.daily;
      const tz = w.timezone;

      const isDay = cur.is_day === 1;
      const wmo = getWMO(cur.weather_code, isDay);

      // Find current hour index
      const nowISO = cur.time;
      let nowIdx = hourly.time.findIndex(t => t === nowISO);
      if (nowIdx < 0) nowIdx = findClosestIdx(hourly.time, nowISO);

      // Current UV from hourly (current doesn't have it)
      const curUV = hourly.uv_index ? hourly.uv_index[nowIdx] : null;
      const curVis = hourly.visibility ? hourly.visibility[nowIdx] : null;
      const curDew = hourly.dew_point_2m ? hourly.dew_point_2m[nowIdx] : null;
      const air = state.airQuality;
      let curAQI = null;
      let curPM25 = null;
      let curPM10 = null;
      if (air && air.hourly && air.hourly.time && air.hourly.time.length) {
        let airIdx = air.hourly.time.findIndex(t => t === nowISO);
        if (airIdx < 0) airIdx = findClosestIdx(air.hourly.time, nowISO);
        curAQI = air.hourly.us_aqi ? air.hourly.us_aqi[airIdx] : null;
        curPM25 = air.hourly.pm2_5 ? air.hourly.pm2_5[airIdx] : null;
        curPM10 = air.hourly.pm10 ? air.hourly.pm10[airIdx] : null;
      }

      // Today high/low
      const todayHi = daily.temperature_2m_max[0];
      const todayLo = daily.temperature_2m_min[0];

      // Updated time
      const updatedTime = new Date(cur.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const content = document.getElementById('content');
      content.innerHTML = `
        <!-- Hero -->
        <div class="grid-main">
          <div class="card hero-current">
            <div class="card-inner">
              <div class="hero-left">
                <div class="hero-location">
                  <i class="fas fa-location-dot loc-pin"></i>
                  ${state.city}
                </div>
                <div class="hero-subloc">${[state.region, state.country].filter(Boolean).join(', ')}</div>
                <div class="hero-temp-row">
                  <div class="hero-temp">${fmt(convTemp(cur.temperature_2m))}<span style="font-size:32px;letter-spacing:0">${tempUnit()}</span></div>
                  <div class="hero-temp-info">
                    <div class="hero-condition">${wmo.text}</div>
                    <div class="hero-feels">Feels like ${fmt(convTemp(cur.apparent_temperature))}${tempUnit()}</div>
                    <div class="hero-hi-lo">
                      <span class="hero-hi"><i class="fas fa-arrow-up"></i> ${fmt(convTemp(todayHi))}Â°</span>
                      <span class="hero-lo"><i class="fas fa-arrow-down"></i> ${fmt(convTemp(todayLo))}Â°</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="hero-right">
                <div class="hero-icon">${wmo.emoji}</div>
                <div class="hero-updated"><i class="fas fa-clock"></i> Updated ${updatedTime}</div>
              </div>
            </div>
          </div>
        </div>

        ${buildSnowForecastCard(daily)}

        <!-- Hourly -->
        <div class="card" style="margin-bottom:16px">
          <div class="card-label"><i class="fas fa-clock"></i> Hourly Forecast</div>
          <div class="card-inner">
            <div class="hourly-scroll" id="hourlyScroll">${buildHourly(hourly, nowIdx)}</div>
          </div>
        </div>

        <!-- Stats + 3-Day -->
        <div class="grid-bottom">
          <!-- 3-Day -->
          <div class="card">
            <div class="card-label"><i class="fas fa-calendar-days"></i> 3-Day Forecast</div>
            <div class="card-inner">
              <div class="daily-list">${buildDaily(daily)}</div>
            </div>
          </div>

          <!-- Sun & Moon -->
          <div class="card">
            <div class="card-label"><i class="fas fa-sun"></i> Sunrise & Sunset</div>
            <div class="card-inner">
              ${buildSunCard(daily, isDay)}
            </div>
          </div>
        </div>

        <!-- Stat Cards Grid -->
        <div class="stats-section" id="statsSection">
          <div class="stats-section-header" onclick="toggleStatsSection()">
            <span class="label"><i class="fas fa-chart-simple"></i> Weather Details</span>
            <button class="stats-section-toggle" onclick="event.stopPropagation(); toggleStatsSection()" id="statsToggleBtn">
              <i class="fas fa-chevron-up" id="statsToggleIcon"></i>
              <span id="statsToggleText">Minimize</span>
            </button>
          </div>
          <div class="stats-section-body">
            <div class="grid-stats">
          ${buildStatCard('Wind', 'fa-wind', fmt(convWind(cur.wind_speed_10m)), windUnit(),
            `Gusts ${fmt(convWind(cur.wind_gusts_10m))} ${windUnit()} &middot; ${getWindDir(cur.wind_direction_10m)}`,
            'var(--green)', cur.wind_direction_10m)}
          ${buildStatCard('Humidity', 'fa-droplet', fmt(cur.relative_humidity_2m), '%',
            `Dew point ${fmt(convTemp(curDew))}${tempUnit()}`, 'var(--accent)')}
          ${buildStatCard('Pressure', 'fa-gauge-high', fmt(cur.pressure_msl, 0), 'hPa',
            getPressureDesc(cur.pressure_msl), 'var(--purple)')}
          ${buildStatCard('UV Index', 'fa-sun', fmt(curUV, 1), '',
            getUVDesc(curUV), 'var(--yellow)')}
          ${curAQI != null ? buildStatCard('Air Quality', 'fa-smog', fmt(curAQI, 0), 'AQI',
            `${getAQIDesc(curAQI)} Â· PM2.5 ${fmt(curPM25, 1)} Âµg/mÂ³ Â· PM10 ${fmt(curPM10, 1)} Âµg/mÂ³`, getAQIColor(curAQI)) : ''}
          ${buildStatCard('Visibility', 'fa-eye', fmt(convVis(curVis != null ? curVis / 1000 : null), 1), visUnit(),
            getVisDesc(curVis), 'var(--cyan)')}
          ${buildStatCard('Cloud Cover', 'fa-cloud', fmt(cur.cloud_cover), '%',
            getCloudDesc(cur.cloud_cover), 'var(--text-muted)')}
          ${buildStatCard('Precipitation', 'fa-cloud-rain', fmt(convPrecip(cur.precipitation), isImperial() ? 2 : 1), precipUnit(),
            `Rain ${fmt(convPrecip(cur.rain), isImperial() ? 2 : 1)} ${precipUnit()}`, 'var(--accent)')}
          ${buildStatCard('Surface Pressure', 'fa-compress', fmt(cur.surface_pressure, 0), 'hPa',
            'At ground level', 'var(--orange)')}
          ${daily.snowfall_sum && daily.snowfall_sum[0] > 0 ? buildStatCard('Snow Today', 'fa-snowflake', fmt(convSnow(daily.snowfall_sum[0]), isImperial() ? 1 : 0), snowUnit(),
            'Predicted for today', 'var(--purple)') : ''}
            </div>
          </div>
        </div>

        <!-- Map -->
        <div class="card map-card" style="margin-bottom:20px">
          <div class="card-label"><i class="fas fa-map"></i> Precipitation Radar</div>
          <div class="map-controls">
            <button class="map-btn active" id="mapRadarBtn" onclick="setMapRadar()">Precipitation</button>
            <button class="map-btn" id="mapPlayBtn" onclick="toggleRadarPlay()">
              <i class="fas fa-play" id="radarPlayIcon"></i> Animate
            </button>
            <button class="map-btn" onclick="recenterMap()"><i class="fas fa-location-crosshairs"></i> Recenter</button>
            <div class="map-control-group">
              <label for="radarOpacity">Opacity</label>
              <input type="range" id="radarOpacity" min="20" max="100" value="60" oninput="setRadarOpacity(this.value)">
            </div>
            <span style="font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:4px;" id="radarTime">Loading radarâ€¦</span>
          </div>
          <div class="card-inner">
            <div id="weatherMap"></div>
          </div>
        </div>
      `;

      initMap();
      initStatsSection();
      // Scroll hourly to "now"
      const scroll = document.getElementById('hourlyScroll');
      const nowEl = scroll.querySelector('.now');
      if (nowEl) nowEl.scrollIntoView({ inline: 'start', block: 'nearest' });
    }

    function toggleStatsSection() {
      const section = document.getElementById('statsSection');
      const icon = document.getElementById('statsToggleIcon');
      const text = document.getElementById('statsToggleText');
      const collapsed = section.classList.toggle('collapsed');
      localStorage.setItem('wx_stats_collapsed', collapsed ? '1' : '0');
      icon.className = collapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
      text.textContent = collapsed ? 'Expand' : 'Minimize';
      if (state.map) {
        setTimeout(() => state.map.invalidateSize(), 400);
      }
    }

    function initStatsSection() {
      const collapsed = localStorage.getItem('wx_stats_collapsed') === '1';
      const section = document.getElementById('statsSection');
      if (!section) return;
      const icon = document.getElementById('statsToggleIcon');
      const text = document.getElementById('statsToggleText');
      if (collapsed) {
        section.classList.add('collapsed');
        if (icon) icon.className = 'fas fa-chevron-down';
        if (text) text.textContent = 'Expand';
        if (state.map) setTimeout(() => state.map.invalidateSize(), 450);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUILD HOURLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildHourly(h, nowIdx) {
      let html = '';
      const count = Math.min(nowIdx + 48, h.time.length);
      for (let i = nowIdx; i < count; i++) {
        const t = new Date(h.time[i]);
        const isNow = i === nowIdx;
        const timeStr = isNow ? 'Now' : t.toLocaleTimeString([], { hour: 'numeric' });
        const isD = h.is_day[i] === 1;
        const wmo = getWMO(h.weather_code[i], isD);
        const temp = convTemp(h.temperature_2m[i]);
        const precip = h.precipitation_probability[i];
        const snow = h.snowfall != null ? h.snowfall[i] : 0;
        const snowLabel = snow > 0 ? `<span class="h-snow"><i class="fas fa-snowflake"></i> ${fmt(convSnow(snow), 1)} ${snowUnit()}</span>` : '';
        const precipLabel = precip > 0 ? `<span class="h-precip"><i class="fas fa-droplet"></i> ${precip}%</span>` : '';
        html += `<div class="hour-item ${isNow ? 'now' : ''}">
          <span class="h-time">${timeStr}</span>
          <span class="h-icon">${wmo.emoji}</span>
          <span class="h-temp">${fmt(temp)}Â°</span>
          ${precipLabel}
          ${snowLabel}
        </div>`;
      }
      return html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUILD DAILY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildDaily(d) {
      let html = '';
      // Find global min/max for bar scaling
      const allMin = Math.min(...d.temperature_2m_min.slice(0, 3));
      const allMax = Math.max(...d.temperature_2m_max.slice(0, 3));
      const range = allMax - allMin || 1;

      for (let i = 0; i < 3; i++) {
        const date = new Date(d.time[i]);
        const dayName = i === 0 ? 'Today' : date.toLocaleDateString([], { weekday: 'short' });
        const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        const wmo = getWMO(d.weather_code[i], true);
        const lo = d.temperature_2m_min[i];
        const hi = d.temperature_2m_max[i];
        const loConv = convTemp(lo);
        const hiConv = convTemp(hi);
        const left = ((lo - allMin) / range) * 100;
        const right = ((hi - allMin) / range) * 100;
        const precip = d.precipitation_probability_max[i];
        const snow = d.snowfall_sum != null ? d.snowfall_sum[i] : 0;
        const snowStr = snow > 0 ? `<i class="fas fa-snowflake"></i> ${fmt(convSnow(snow), isImperial() ? 1 : 0)} ${snowUnit()}` : '';
        html += `<div class="daily-row">
          <div class="daily-day">${dayName}<span class="day-date">${dateStr}</span></div>
          <div class="daily-icon">${wmo.emoji}</div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="daily-lo">${fmt(loConv)}Â°</span>
            <div class="daily-bar">
              <div class="daily-bar-fill" style="left:${left}%;right:${100-right}%"></div>
            </div>
            <span class="daily-hi">${fmt(hiConv)}Â°</span>
          </div>
          <div class="daily-precip-col">${precip > 0 ? `<i class="fas fa-droplet"></i> ${precip}%` : ''}</div>
          <div class="daily-snow-col">${snowStr}</div>
        </div>`;
      }
      return html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUILD SNOW FORECAST CARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildSnowForecastCard(d) {
      if (!d.snowfall_sum) return '';
      const totals = d.snowfall_sum.slice(0, 3);
      const hasSnow = totals.some(s => s > 0);
      if (!hasSnow) return '';

      const totalSnow = totals.reduce((a, b) => a + b, 0);
      const items = totals.map((snow, i) => {
        if (snow <= 0) return '';
        const date = new Date(d.time[i]);
        const name = i === 0 ? 'Today' : (i === 1 ? 'Tomorrow' : date.toLocaleDateString([], { weekday: 'short' }));
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
          <span style="font-weight:600">${name}</span>
          <span style="color:var(--purple);font-weight:700"><i class="fas fa-snowflake"></i> ${fmt(convSnow(snow), isImperial() ? 1 : 0)} ${snowUnit()}</span>
        </div>`;
      }).filter(Boolean).join('');

      return `<div class="card snow-forecast-card" style="margin-bottom:16px">
        <div class="card-label"><i class="fas fa-snowflake"></i> Predicted Snow Totals</div>
        <div class="card-inner">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:13px;color:var(--text-muted)">Next 3 days</span>
            <span style="font-size:20px;font-weight:700;color:var(--purple)"><i class="fas fa-snowflake"></i> ${fmt(convSnow(totalSnow), isImperial() ? 1 : 0)} ${snowUnit()} total</span>
          </div>
          ${items}
        </div>
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUILD SUN CARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildSunCard(d, isDay) {
      const sunrise = new Date(d.sunrise[0]);
      const sunset = new Date(d.sunset[0]);
      const riseStr = sunrise.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const setStr = sunset.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const daylight = d.daylight_duration[0];
      const dH = Math.floor(daylight / 3600);
      const dM = Math.floor((daylight % 3600) / 60);
      const sunshine = d.sunshine_duration[0];
      const sH = Math.floor(sunshine / 3600);
      const sM = Math.floor((sunshine % 3600) / 60);

      // Calculate sun position for arc
      const now = new Date();
      const riseMs = sunrise.getTime();
      const setMs = sunset.getTime();
      const nowMs = now.getTime();
      let sunProgress = 0;
      if (nowMs >= riseMs && nowMs <= setMs) {
        sunProgress = (nowMs - riseMs) / (setMs - riseMs);
      } else if (nowMs > setMs) {
        sunProgress = 1;
      }

      // SVG arc
      const arcWidth = 200;
      const arcHeight = 70;
      const cx = arcWidth / 2;
      const startX = 10;
      const endX = arcWidth - 10;
      // Sun position on arc
      const sunX = startX + sunProgress * (endX - startX);
      const sunY = arcHeight - Math.sin(sunProgress * Math.PI) * (arcHeight - 10);
      const sunColor = isDay ? '#fbbf24' : '#64748b';

      return `
        <div class="sun-visual">
          <div class="sun-arc">
            <svg viewBox="0 0 ${arcWidth} ${arcHeight + 10}" preserveAspectRatio="xMidYMid meet">
              <defs>
                <linearGradient id="arcGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--yellow)" stop-opacity="0.2" />
                  <stop offset="50%" stop-color="var(--yellow)" stop-opacity="0.5" />
                  <stop offset="100%" stop-color="var(--orange)" stop-opacity="0.2" />
                </linearGradient>
              </defs>
              <!-- Horizon line -->
              <line x1="${startX}" y1="${arcHeight}" x2="${endX}" y2="${arcHeight}" stroke="var(--border-light)" stroke-width="1" stroke-dasharray="4,4" />
              <!-- Arc -->
              <path d="M ${startX},${arcHeight} Q ${cx},${arcHeight - 120} ${endX},${arcHeight}"
                    fill="none" stroke="url(#arcGrad)" stroke-width="2" />
              <!-- Traveled portion -->
              ${sunProgress > 0 && sunProgress < 1 ? `
                <path d="M ${startX},${arcHeight} Q ${cx},${arcHeight - 120} ${endX},${arcHeight}"
                      fill="none" stroke="var(--yellow)" stroke-width="2"
                      stroke-dasharray="${sunProgress * 250},500" opacity="0.7" />
              ` : ''}
              <!-- Sun dot -->
              <circle cx="${sunX}" cy="${sunY}" r="6" fill="${sunColor}" opacity="0.9" />
              <circle cx="${sunX}" cy="${sunY}" r="10" fill="${sunColor}" opacity="0.2" />
            </svg>
          </div>
        </div>
        <div class="sun-times">
          <div class="sun-rise">
            <i class="fas fa-sunrise"></i>
            <span class="sun-time-val">${riseStr}</span>
            <span class="sun-label">Sunrise</span>
          </div>
          <div style="text-align:center">
            <div style="font-size:11px;color:var(--text-muted)">Daylight</div>
            <div style="font-weight:600;font-size:14px">${dH}h ${dM}m</div>
            <div style="font-size:10px;color:var(--text-muted)">Sunshine ${sH}h ${sM}m</div>
          </div>
          <div class="sun-set">
            <i class="fas fa-sunset"></i>
            <span class="sun-time-val">${setStr}</span>
            <span class="sun-label">Sunset</span>
          </div>
        </div>
      `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BUILD STAT CARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildStatCard(title, icon, value, unit, desc, color, windDir) {
      const windArrow = windDir != null ? `
        <div class="wind-arrow">
          <i class="fas fa-location-arrow" style="transform:rotate(${windDir + 135}deg);color:${color};font-size:16px"></i>
        </div>` : '';
      return `<div class="card stat-card">
        <div class="card-inner">
          <div class="stat-header">
            <span class="stat-title">${title}</span>
            <i class="fas ${icon}" style="color:${color}"></i>
          </div>
          <div style="display:flex;align-items:end;gap:10px">
            <div>
              <div class="stat-value">${value} <span class="stat-unit">${unit}</span></div>
              <div class="stat-desc">${desc}</div>
            </div>
            ${windArrow}
          </div>
        </div>
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function findClosestIdx(times, target) {
      const t = new Date(target).getTime();
      let closest = 0, diff = Infinity;
      times.forEach((ti, i) => {
        const d = Math.abs(new Date(ti).getTime() - t);
        if (d < diff) { diff = d; closest = i; }
      });
      return closest;
    }

    function getWindDir(deg) {
      if (deg == null) return '--';
      const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function getPressureDesc(p) {
      if (p == null) return '--';
      if (p < 1000) return 'Low pressure';
      if (p < 1013) return 'Below average';
      if (p < 1020) return 'Normal';
      return 'High pressure';
    }

    function getUVDesc(uv) {
      if (uv == null) return '--';
      if (uv < 3) return 'Low';
      if (uv < 6) return 'Moderate';
      if (uv < 8) return 'High';
      if (uv < 11) return 'Very High';
      return 'Extreme';
    }

    function getVisDesc(vis) {
      if (vis == null) return '--';
      const km = vis / 1000;
      if (km < 1) return 'Very poor';
      if (km < 4) return 'Poor';
      if (km < 10) return 'Moderate';
      if (km < 20) return 'Good';
      return 'Excellent';
    }

    function getCloudDesc(c) {
      if (c == null) return '--';
      if (c < 10) return 'Clear sky';
      if (c < 30) return 'Mostly clear';
      if (c < 60) return 'Partly cloudy';
      if (c < 85) return 'Mostly cloudy';
      return 'Overcast';
    }

    function getAQIDesc(aqi) {
      if (aqi == null) return '--';
      if (aqi <= 50) return 'Good';
      if (aqi <= 100) return 'Moderate';
      if (aqi <= 150) return 'Unhealthy for Sensitive';
      if (aqi <= 200) return 'Unhealthy';
      if (aqi <= 300) return 'Very Unhealthy';
      return 'Hazardous';
    }

    function getAQIColor(aqi) {
      if (aqi == null) return 'var(--text-muted)';
      if (aqi <= 50) return 'var(--green)';
      if (aqi <= 100) return 'var(--yellow)';
      if (aqi <= 150) return 'var(--orange)';
      if (aqi <= 200) return 'var(--red)';
      if (aqi <= 300) return 'var(--purple)';
      return 'var(--pink)';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAP + RADAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initMap() {
      if (state.map) { state.map.remove(); state.map = null; }
      if (state.radarInterval) { clearInterval(state.radarInterval); state.radarPlaying = false; }

      state.map = L.map('weatherMap', {
        center: [state.lat, state.lon],
        zoom: 7,
        zoomControl: true,
        attributionControl: false
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 18, subdomains: 'abcd'
      }).addTo(state.map);

      // Location marker
      L.circleMarker([state.lat, state.lon], {
        radius: 7, fillColor: '#38bdf8', fillOpacity: 1,
        color: '#fff', weight: 2
      }).addTo(state.map).bindTooltip(state.city || 'Current location', { direction: 'top' });

      // Load RainViewer radar
      loadRadar();
    }

    async function loadRadar() {
      try {
        const res = await fetch(RAINVIEWER_API);
        const data = await res.json();
        const past = data.radar?.past || [];
        const nowcast = data.radar?.nowcast || [];
        state.radarFrames = [...past, ...nowcast];
        state.radarIdx = past.length - 1; // latest actual frame

        if (state.radarFrames.length > 0) {
          addRadarFrame(state.radarIdx);
        } else {
          const el = document.getElementById('radarTime');
          if (el) el.textContent = 'No radar frames available';
        }
      } catch(e) {
        console.warn('RainViewer load error:', e);
        const el = document.getElementById('radarTime');
        if (el) el.textContent = 'Radar unavailable';
      }
    }

    function addRadarFrame(idx) {
      if (state.radarLayer) { state.map.removeLayer(state.radarLayer); }
      const frame = state.radarFrames[idx];
      if (!frame) return;
      state.radarLayer = L.tileLayer(
        `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, {
        opacity: state.radarOpacity, maxZoom: 18, zIndex: 10
      }).addTo(state.map);

      const time = new Date(frame.time * 1000);
      const el = document.getElementById('radarTime');
      if (el) {
        const mode = state.radarPlaying ? 'Animating' : 'Frame';
        el.textContent = `${mode}: ${time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      }
    }

    function setMapRadar() {
      if (state.radarFrames.length > 0) {
        state.radarIdx = state.radarFrames.length - 1;
        addRadarFrame(state.radarIdx);
      }
    }

    function setRadarOpacity(value) {
      state.radarOpacity = Number(value) / 100;
      if (state.radarLayer) state.radarLayer.setOpacity(state.radarOpacity);
    }

    function recenterMap() {
      if (state.map && state.lat != null && state.lon != null) {
        state.map.flyTo([state.lat, state.lon], Math.max(state.map.getZoom(), 7), { duration: 0.6 });
      }
    }

    function toggleRadarPlay() {
      if (!state.radarFrames.length) return;
      state.radarPlaying = !state.radarPlaying;
      const icon = document.getElementById('radarPlayIcon');
      const btn = document.getElementById('mapPlayBtn');

      if (state.radarPlaying) {
        icon.className = 'fas fa-pause';
        btn.classList.add('active');
        state.radarInterval = setInterval(() => {
          state.radarIdx = (state.radarIdx + 1) % state.radarFrames.length;
          addRadarFrame(state.radarIdx);
        }, 600);
      } else {
        icon.className = 'fas fa-play';
        btn.classList.remove('active');
        clearInterval(state.radarInterval);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showLoader(msg) {
      const loader = document.getElementById('loader');
      loader.querySelector('p').textContent = msg || 'Loading...';
      loader.classList.remove('hidden');
      document.getElementById('app').classList.remove('visible');
    }

    function hideLoader() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('app').classList.add('visible');
    }

    function showError(title, msg) {
      hideLoader();
      document.getElementById('content').innerHTML = `
        <div class="error-msg">
          <i class="fas fa-exclamation-triangle"></i>
          <h2>${title}</h2>
          <p>${msg}</p>
          <button class="btn" onclick="detectLocation()" style="margin:0 auto">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>
      `;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('unitLabel').textContent = tempUnit();
    if (state.units === 'imperial') {
      document.getElementById('unitToggle').classList.add('active');
    }

    // Start!
    detectLocation();
  </script>
</body>
</html>
